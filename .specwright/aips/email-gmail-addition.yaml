aip_id: AIP-life-2025-12-18-001
context:
  background: 'The `life email` command currently only supports Microsoft Exchange via MS Graph API (morch
    library). Users with Gmail accounts cannot use `life email send` to send from those accounts.


    The `gorch` package provides a fully implemented `GmailClient` that mirrors the morch `GraphClient`
    pattern:

    - `GmailClient.from_authctl(account)` for authentication

    - `send_message(to, subject, body, html=False)` for sending


    Provider selection should be config-driven: accounts listed in `email.gmail_accounts` use gorch, accounts
    in `email.msgraph_accounts` use morch, unlisted accounts default to msgraph.'
  constraints:
  - Must maintain backwards compatibility (existing msgraph accounts work unchanged)
  - No edits under protected paths (`src/core/**`, `infra/**`)
  - GmailClient.send_message() only accepts single recipient (loop for multiple)
created: '2025-12-18T21:43:57.291248+00:00'
meta:
  created_at: '2025-12-18T21:43:57.291248+00:00'
  created_by: benthepsychologist
objective:
  acceptance_criteria:
  - '`life email send --account gmail-acct` sends via Gmail API when account is in `email.gmail_accounts`
    config'
  - '`life email send --account msgraph-acct` continues to work via MS Graph (backwards compatible)'
  - '`life email batch` works with both providers'
  - Default to msgraph for unlisted accounts (backwards compat)
  - If an account appears in both `email.gmail_accounts` and `email.msgraph_accounts`, `gmail` wins (explicit
    precedence)
  - For Gmail + multiple recipients, implementation sends one message per recipient (documented behavior)
  - CI green (`ruff` + `pytest`)
  - New tests cover provider lookup + both provider branches (gmail + default msgraph)
  goal: Enable sending emails via Gmail accounts using gorch alongside existing MS Graph/morch support
orchestrator_contract:
  artifacts_dir: .aip_artifacts/AIP-life-2025-12-18-001
  logging: jsonl
  state_machine:
    events:
    - run_step
    - await_gate
    - approve
    - reject
    - retry
    - escalate
    - complete
    states:
    - pending
    - running
    - awaiting_human
    - failed
    - succeeded
    - rolled_back
plan:
- allowed_paths:
  - pyproject.toml
  description: Add gorch dependency
  gate_ref: 'G1: Code Readiness'
  kind: code
  outputs:
  - pyproject.toml
  prompt: "Add gorch as a dependency in pyproject.toml:\n```toml\ndependencies = [\n    ...existing deps...,\n\
    \    \"gorch>=0.1.0\",\n]\n```\nNote: This assumes `gorch` is resolvable in CI (published to the configured\
    \ package index, a VCS URL dependency, or your repo’s standard monorepo/path dependency approach).\
    \ If CI cannot resolve `gorch`, dependency installation will fail."
  role: coding_agent
  step_id: step-001
  verification_commands:
  - python -m pip install -e ".[dev]"
  - python -c "import gorch, morch"
  - ruff check .
- allowed_paths:
  - src/life_jobs/email.py
  description: Update email processor with provider dispatch
  kind: code
  outputs:
  - src/life_jobs/email.py
  prompt: "Modify `src/life_jobs/email.py` to support both msgraph and gmail providers:\n1. Add `provider:\
    \ str = \"msgraph\"` parameter to `send()`, `send_templated()`, and `batch_send()` functions (default\
    \ remains msgraph for backwards compatibility)\n2. Create internal `_send_via_provider()` helper that\
    \ dispatches based on provider:\n```python\ndef _send_via_provider(\n    provider: str,\n    account:\
    \ str,\n    to: List[str],\n    subject: str,\n    body: str,\n    is_html: bool,\n) -> Dict[str,\
    \ Any]:\n    \"\"\"Send email via specified provider.\"\"\"\n    try:\n        if provider == \"gmail\"\
    :\n            from gorch.gmail import GmailClient\n            client = GmailClient.from_authctl(account)\n\
    \            # GmailClient only accepts single recipient (send one per recipient)\n            for\
    \ recipient in to:\n                client.send_message(recipient, subject, body, html=is_html)\n\
    \        else:  # msgraph (default)\n            from morch import GraphClient\n            client\
    \ = GraphClient.from_authctl(account, scopes=[\"Mail.Send\"])\n            message = {\n         \
    \       \"subject\": subject,\n                \"body\": {\n                    \"contentType\": \"\
    HTML\" if is_html else \"Text\",\n                    \"content\": body,\n                },\n   \
    \             \"toRecipients\": [{\"emailAddress\": {\"address\": addr}} for addr in to],\n      \
    \      }\n            client.post(\"/me/sendMail\", {\"message\": message})\n        return {\"sent\"\
    : True, \"to\": to, \"subject\": subject, \"error\": None}\n    except Exception as e:\n        return\
    \ {\"sent\": False, \"to\": to, \"subject\": subject, \"error\": str(e)}\n```\n3. Update `send()`\
    \ to call `_send_via_provider()` (preserve existing return shape)\n4. Update `send_templated()` to\
    \ accept and pass `provider` parameter (preserve existing return shape: `to` remains a single string)\n\
    5. Update `batch_send()` to accept and pass `provider` parameter to `send_templated()` (no behavior\
    \ change beyond provider selection)\n6. Update `__io__` declaration to include gmail external call\
    \ (keep existing keys; add e.g. `gmail.send_message`)\n7. Update module docstring to mention Gmail\
    \ support and update “Side effects” to include gorch"
  role: coding_agent
  step_id: step-002
  verification_commands:
  - ruff check src/life_jobs/email.py
  - python -c "import sys; sys.path.insert(0, 'src'); from life_jobs.email import send, send_templated,
    batch_send"
- allowed_paths:
  - src/life/commands/email.py
  description: Update CLI commands with provider lookup
  kind: code
  outputs:
  - src/life/commands/email.py
  prompt: "Modify `src/life/commands/email.py` to determine provider from config:\n1. Add helper function\
    \ to lookup provider for an account:\n```python\ndef _get_provider_for_account(account: str, config:\
    \ dict) -> str:\n    \"\"\"Determine email provider for account from config.\n    Checks email.gmail_accounts\
    \ and email.msgraph_accounts lists.\n    If the account is in both lists, gmail wins.\n    Defaults\
    \ to msgraph for backwards compatibility.\n    \"\"\"\n    email_config = config.get(\"email\", {})\n\
    \    gmail_accounts = email_config.get(\"gmail_accounts\", [])\n    msgraph_accounts = email_config.get(\"\
    msgraph_accounts\", [])\n    if account in gmail_accounts:\n        return \"gmail\"\n    if account\
    \ in msgraph_accounts:\n        return \"msgraph\"\n    # Default to msgraph for backwards compat\n\
    \    return \"msgraph\"\n```\n2. Update `send()` command to:\n   - Call `_get_provider_for_account()`\
    \ to determine provider\n   - Pass `provider` in variables dict to `run_job()`\n3. Update `batch()`\
    \ command similarly\n4. Update help text: `app = typer.Typer(help=\"Send emails via MS Graph or Gmail\"\
    )`"
  role: coding_agent
  step_id: step-003
  verification_commands:
  - ruff check src/life/commands/email.py
  - python -c "import sys; sys.path.insert(0, 'src'); from life.commands.email import app"
- allowed_paths:
  - src/life/jobs/email.yaml
  description: Update job definitions
  kind: code
  outputs:
  - src/life/jobs/email.yaml
  prompt: "Modify `src/life/jobs/email.yaml` to include provider variable in all email jobs:\n```yaml\n\
    jobs:\n  email.send:\n    description: \"Send a single email\"\n    steps:\n      - name: send\n \
    \       call: life_jobs.email.send\n        args:\n          account: \"{account}\"\n          to:\
    \ [\"{to}\"]\n          subject: \"{subject}\"\n          body: \"{body}\"\n          provider: \"\
    {provider}\"\n  email.send_templated:\n    description: \"Send templated email to one recipient\"\n\
    \    steps:\n      - name: send\n        call: life_jobs.email.send_templated\n        args:\n   \
    \       account: \"{account}\"\n          to: \"{to}\"\n          template: \"{template}\"\n     \
    \     provider: \"{provider}\"\n  email.batch_send:\n    description: \"Send templated emails to list\"\
    \n    steps:\n      - name: batch\n        call: life_jobs.email.batch_send\n        args:\n     \
    \     account: \"{account}\"\n          template: \"{template}\"\n          recipients_file: \"{recipients_file}\"\
    \n          dry_run: \"{dry_run}\"\n          provider: \"{provider}\"\n```"
  role: coding_agent
  step_id: step-004
  verification_commands:
  - python -c "import sys; sys.path.insert(0, 'src'); from pathlib import Path; from life.job_runner import
    load_jobs; jobs = load_jobs(Path('src/life/jobs')); assert 'email.send' in jobs"
- allowed_paths:
  - tests/test_life_jobs_email.py
  - tests/test_email_commands.py
  description: Add tests for provider dispatch
  kind: code
  outputs:
  - tests/test_life_jobs_email.py
  prompt: "Add tests in `tests/test_life_jobs_email.py` (or update existing):\n1. Test `_send_via_provider()`\
    \ with mocked GraphClient\n2. Test `_send_via_provider()` with mocked GmailClient\n3. Test `_get_provider_for_account()`\
    \ with various config scenarios:\n   - Account in gmail_accounts returns \"gmail\"\n   - Account in\
    \ msgraph_accounts returns \"msgraph\"\n   - Unlisted account returns \"msgraph\" (default)\n4. Test\
    \ that `send()` passes provider correctly"
  role: coding_agent
  step_id: step-005
  verification_commands:
  - ruff check tests/
  - pytest tests/test_life_jobs_email.py -v
  - pytest -q --cov=life_jobs.email --cov-report=term-missing
  - pytest -q
project_slug: life
repo:
  default_branch: main
  url: git@github.com:benthepsychologist/life.git
  working_branch: feat/email-gmail-addition
spec_version: 1.0.0
tier: C
title: Add Gmail Support to life email
updated: '2025-12-18T21:43:57.291248+00:00'
version: '0.1'

